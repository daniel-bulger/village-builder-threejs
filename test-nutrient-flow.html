<!DOCTYPE html>
<html>
<head>
  <title>Nutrient Flow Test</title>
</head>
<body>
  <h1>Nutrient Flow Test</h1>
  <button onclick="testNutrientFlow()">Test Nutrient Flow</button>
  <pre id="output"></pre>

  <script>
    function testNutrientFlow() {
      const output = document.getElementById('output');
      
      // Access game window
      const gameWindow = window.opener || window.parent || window;
      const game = gameWindow.game;
      
      if (!game) {
        output.textContent = 'Game not found. Make sure the game is running.';
        return;
      }
      
      const coord = { q: 0, r: 0, y: 0 };
      const nutrientSystem = game.soilManager.getNutrientSystem();
      const plantSim = game.soilManager.getPlantSimulation();
      
      // Test 1: Check if nutrient system exists
      output.textContent = 'Test 1: Nutrient system exists? ' + (nutrientSystem ? 'YES' : 'NO') + '\n';
      
      // Test 2: Place soil and check nutrients
      game.soilManager.placeSoil(coord);
      const nutrients1 = nutrientSystem.getNutrients(coord);
      output.textContent += 'Test 2: Initial nutrients: ' + JSON.stringify(nutrients1) + '\n';
      
      // Test 3: Add water
      const waterSim = game.soilManager.getWaterSimulation();
      waterSim.addWater(coord, 50000);
      output.textContent += 'Test 3: Water added\n';
      
      // Test 4: Plant a tomato
      const worldPos = new gameWindow.THREE.Vector3(
        coord.q * 1.5,
        0.15,
        (coord.r + coord.q * 0.5) * Math.sqrt(3)
      );
      const plantId = plantSim.plantSeed('tomato', worldPos);
      output.textContent += 'Test 4: Plant created? ' + (plantId ? 'YES' : 'NO') + '\n';
      
      if (plantId) {
        // Test 5: Get plant and check its position
        const plants = plantSim.getAllPlants();
        const plant = plants.find(p => p.plant.id === plantId);
        if (plant) {
          output.textContent += 'Test 5: Plant position: ' + JSON.stringify(plant.plant.position) + '\n';
          
          // Test 6: Manually trigger growth
          const plantType = plantSim.getPlantType('tomato');
          output.textContent += 'Test 6: Manually advancing plant growth...\n';
          
          // Force advance the plant
          plant.plant.currentStage = 1;
          plant.plant.growthTimer = 0;
          
          // Call depletion directly
          const hexCoord = { q: 0, r: 0 };
          const soilY = Math.floor(plant.plant.position.y) - 1;
          const hex3D = { q: hexCoord.q, r: hexCoord.r, y: soilY };
          
          output.textContent += 'Test 7: Calling depletion for hex: ' + JSON.stringify(hex3D) + '\n';
          const depleted = nutrientSystem.depleteNutrients(hex3D, 'tomato', 1);
          output.textContent += 'Test 8: Depletion successful? ' + depleted + '\n';
          
          // Check nutrients after
          const nutrients2 = nutrientSystem.getNutrients(coord);
          output.textContent += 'Test 9: Nutrients after depletion: ' + JSON.stringify(nutrients2) + '\n';
          
          // Check if the nutrients changed
          if (nutrients1 && nutrients2) {
            output.textContent += 'Test 10: Nutrients changed? ' + 
              (nutrients1.nitrogen !== nutrients2.nitrogen ? 'YES' : 'NO') + '\n';
          }
          
          // Test hover info
          game.soilManager.hoveredHex = coord;
          game.soilManager.hoveredY = 0;
          const info = game.soilManager.getHoveredHexNutrientInfo();
          output.textContent += 'Test 11: Hover info: ' + info + '\n';
        }
      }
    }
  </script>
</body>
</html>